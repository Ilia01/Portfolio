---
title: "Building Aegis2FA: Learning Authentication the Hard Way"
description: "How I built a complete 2FA service to understand authentication patterns—TOTP, JWT refresh tokens, Argon2, and rate limiting. A technical deep-dive into what I learned."
date: 2025-01-15
published: true
tags: ["authentication", "security", "backend", "learning"]
---

## Why Build This?

I wanted to understand authentication beyond tutorials. How does TOTP actually work? Why is Argon2 better than bcrypt? How do you prevent JWT token theft?

The best way to learn is to build. So I built **Aegis2FA**—a complete 2FA service with:

- Multiple authentication methods (TOTP, SMS, Email, Backup codes)
- Modern security patterns (Argon2id, JWT with refresh tokens)
- Comprehensive documentation
- 80%+ test coverage

This isn't production software—it's a learning project that demonstrates real authentication patterns. Here's what I learned building it.

## Technical Architecture

### Backend Stack

```typescript
// Core authentication flow with NestJS
@Injectable()
export class TwoFactorService {
  async verifyTotp(userId: string, token: string): Promise<boolean> {
    const user = await this.userRepository.findById(userId);

    // Verify token using speakeasy
    return speakeasy.totp.verify({
      secret: user.totpSecret,
      encoding: 'base32',
      token,
      window: 2, // Allow 60-second time skew
    });
  }
}
```

### Key Design Decisions

**Why Argon2id over bcrypt?**

Winner of the Password Hashing Competition, resistant to GPU cracking attacks, with configurable memory and time costs, and better protection against side-channel attacks.

**Why JWT with refresh tokens?**

Stateless authentication with short-lived access tokens (15min) and long-lived refresh tokens (7 days) stored securely with automatic rotation on use.

## Challenges Faced

### Race Conditions in Token Generation

**Problem**: Multiple simultaneous requests could generate duplicate tokens.

**Solution**: Implemented Redis-based distributed locking:

```typescript
async generateBackupCodes(userId: string): Promise<string[]> {
  const lock = await this.redisClient.acquireLock(`backup:${userId}`, 5000);

  try {
    // Generate codes with cryptographically secure random
    const codes = Array.from({ length: 10 }, () =>
      crypto.randomBytes(4).toString('hex')
    );

    // Hash and store
    await this.storeHashedCodes(userId, codes);

    return codes;
  } finally {
    await lock.release();
  }
}
```

### SMS Delivery Reliability

**Problem**: SMS providers have varying delivery times and failure rates.

**Solution**: Implemented a fallback queue system with exponential backoff and multiple provider support.

### TOTP Clock Drift

**Problem**: User devices may have inaccurate clocks, causing valid tokens to be rejected.

**Solution**: Added a configurable time window of ±60 seconds and implemented NTP sync recommendations in the client app.

## What I Learned

**Security isn't optional**: Every endpoint needs rate limiting. Every password needs proper hashing. Every token needs validation. No shortcuts.

**Documentation teaches you**: Writing docs for Aegis2FA forced me to understand edge cases I'd missed. If you can't explain it clearly, you don't fully understand it.

**Tests catch real bugs**: Integration tests found 3 race conditions I would've shipped. Token reuse vulnerability caught by a simple test. Password length DoS attack prevented because someone wrote a test with 10,000 character passwords.

**Production patterns matter**: Even in a learning project, using real patterns (JWT rotation, distributed locks, structured logging) teaches you how production systems actually work.

## Applying These Lessons

I'm now using these authentication patterns in production systems at Andersen. Understanding TOTP internals, JWT security, and rate limiting strategies helps me make better architecture decisions for real projects.

## What's Next

Planning to add WebAuthn/FIDO2 support for passwordless authentication and an admin dashboard. These features will give me hands-on experience with modern auth standards.

## Try It Yourself

Check out the project on GitHub at github.com/Ilia01/Aegis2FA, read the full documentation at ilia01.github.io/Aegis2FA, or try the interactive demo without signing up.

---

*Have questions about the implementation? Found a bug? Open an issue on GitHub or reach out via email.*
